#!/bin/bash
#
# Automatic IPsec/L2TP VPN + Shadowsocks (Docker)
# Rocky Linux 10 ONLY
#

set -e
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
SYS_DT=$(date +%F-%T)

### ===============================
### USER CONFIG (optional)
### ===============================
YOUR_USERNAME=""
YOUR_PASSWORD=""
YOUR_IPSEC_PSK=""

# Shadowsocks
SS_PORT=9000
SS_METHOD="aes-256-gcm"

gen() { tr -dc 'A-HJ-NPR-Za-km-z2-9' </dev/urandom | head -c "$1"; }

VPN_USER=${YOUR_USERNAME:-vpnuser}
VPN_PASSWORD=${YOUR_PASSWORD:-$(gen 16)}
VPN_IPSEC_PSK=${YOUR_IPSEC_PSK:-$(gen 20)}
SS_PASSWORD=$(gen 16)

exiterr() { echo "ERROR: $1" >&2; exit 1; }
conf_bk() { cp -f "$1" "$1.old-$SYS_DT" 2>/dev/null || true; }
bigecho() { echo; echo "## $1"; echo; }

### ===============================
### ROOT + OS CHECK
### ===============================
[ "$(id -u)" != 0 ] && exiterr "Run as root"

grep -qs "Rocky Linux" /etc/os-release || exiterr "Rocky Linux only"
grep -qs "VERSION_ID=\"10" /etc/os-release || exiterr "Rocky Linux 10 only"

### ===============================
### NETWORK
### ===============================
DEF_IFACE=$(ip route get 1.1.1.1 | awk '{print $5; exit}')

### ===============================
### INSTALL PACKAGES
### ===============================
bigecho "Installing packages..."

dnf -y install epel-release
dnf -y update

dnf -y install \
  libreswan xl2tpd ppp \
  firewalld fail2ban \
  wget curl bind-utils net-tools \
  iptables-nft \
  docker

systemctl enable --now firewalld
systemctl enable --now docker

### ===============================
### PUBLIC IP
### ===============================
bigecho "Detecting public IP..."

PUBLIC_IP=$(dig +short myip.opendns.com @resolver1.opendns.com || true)
[ -z "$PUBLIC_IP" ] && PUBLIC_IP=$(curl -4 -s ifconfig.me)
[ -z "$PUBLIC_IP" ] && exiterr "Cannot detect public IP"

### ===============================
### SYSCTL
### ===============================
bigecho "Applying sysctl..."

conf_bk /etc/sysctl.conf
cat >>/etc/sysctl.conf <<EOF

# Added by VPN script
net.ipv4.ip_forward=1
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.all.send_redirects=0
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.accept_redirects=0
net.ipv4.conf.default.send_redirects=0
net.ipv4.conf.default.rp_filter=0
EOF

sysctl -p

### ===============================
### IPSEC CONFIG
### ===============================
bigecho "Configuring IPsec..."

conf_bk /etc/ipsec.conf
cat >/etc/ipsec.conf <<EOF
config setup
  uniqueids=no

conn shared
  left=%defaultroute
  leftid=$PUBLIC_IP
  right=%any
  encapsulation=yes
  authby=secret
  pfs=no
  rekey=no
  ikev2=never

conn l2tp-psk
  auto=add
  leftprotoport=17/1701
  rightprotoport=17/%any
  type=transport
  phase2=esp
  also=shared
EOF

conf_bk /etc/ipsec.secrets
echo "%any %any : PSK \"$VPN_IPSEC_PSK\"" >/etc/ipsec.secrets
chmod 600 /etc/ipsec.secrets

### ===============================
### XL2TPD
### ===============================
bigecho "Configuring xl2tpd..."

conf_bk /etc/xl2tpd/xl2tpd.conf
cat >/etc/xl2tpd/xl2tpd.conf <<EOF
[global]
port = 1701

[lns default]
ip range = 192.168.42.10-192.168.42.250
local ip = 192.168.42.1
require chap = yes
refuse pap = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes
EOF

conf_bk /etc/ppp/options.xl2tpd
cat >/etc/ppp/options.xl2tpd <<EOF
+mschap-v2
auth
mtu 1280
mru 1280
ms-dns 8.8.8.8
ms-dns 1.1.1.1
EOF

conf_bk /etc/ppp/chap-secrets
echo "$VPN_USER l2tpd $VPN_PASSWORD *" >/etc/ppp/chap-secrets
chmod 600 /etc/ppp/chap-secrets

### ===============================
### FIREWALLD
### ===============================
bigecho "Configuring firewall..."

firewall-cmd --permanent --add-service=ipsec
firewall-cmd --permanent --add-port=1701/udp
firewall-cmd --permanent --add-port=${SS_PORT}/tcp
firewall-cmd --permanent --add-port=${SS_PORT}/udp
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

### ===============================
### FAIL2BAN
### ===============================
bigecho "Configuring Fail2Ban..."

cat >/etc/fail2ban/jail.local <<EOF
[sshd]
enabled = true
backend = systemd
EOF

systemctl enable --now fail2ban

### ===============================
### SHADOWSOCKS (DOCKER)
### ===============================
bigecho "Starting Shadowsocks (Docker)..."

docker rm -f shadowsocks >/dev/null 2>&1 || true

docker run -d \
  --name shadowsocks \
  --restart unless-stopped \
  -p ${SS_PORT}:${SS_PORT}/tcp \
  -p ${SS_PORT}:${SS_PORT}/udp \
  shadowsocks/shadowsocks-libev \
  ss-server -s 0.0.0.0 -p ${SS_PORT} \
  -k ${SS_PASSWORD} -m ${SS_METHOD}

### ===============================
### START SERVICES
### ===============================
bigecho "Starting VPN services..."

systemctl enable --now ipsec xl2tpd

### ===============================
### SHADOWSOCKS LINK
### ===============================
SS_BASE64=$(echo -n "$SS_METHOD:$SS_PASSWORD" | base64 | tr -d '=')
SS_LINK="ss://$SS_BASE64@$PUBLIC_IP:$SS_PORT"

### ===============================
### OUTPUT
### ===============================
cat <<EOF

====================================
 IPsec/L2TP VPN READY (Rocky 10)
====================================
 Server IP : $PUBLIC_IP
 Username  : $VPN_USER
 Password  : $VPN_PASSWORD
 PSK       : $VPN_IPSEC_PSK
====================================

====================================
 SHADOWSOCKS READY (Docker)
====================================
 Server IP : $PUBLIC_IP
 Port      : $SS_PORT
 Method    : $SS_METHOD
 Password  : $SS_PASSWORD

 ss:// LINK:
 $SS_LINK
====================================

EOF
